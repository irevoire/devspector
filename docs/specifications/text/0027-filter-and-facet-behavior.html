<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Welcome to the Meilisearch dev specifications!</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.b26ff90a.css" as="style"><link rel="preload" href="/assets/js/app.37877e6b.js" as="script"><link rel="preload" href="/assets/js/3.7860be15.js" as="script"><link rel="preload" href="/assets/js/14.da29c9f9.js" as="script"><link rel="prefetch" href="/assets/js/10.867f19e5.js"><link rel="prefetch" href="/assets/js/11.5950006a.js"><link rel="prefetch" href="/assets/js/12.3fc27b6c.js"><link rel="prefetch" href="/assets/js/13.16281616.js"><link rel="prefetch" href="/assets/js/15.ce1b8490.js"><link rel="prefetch" href="/assets/js/16.e30e1077.js"><link rel="prefetch" href="/assets/js/17.13c224fe.js"><link rel="prefetch" href="/assets/js/18.f87d82ff.js"><link rel="prefetch" href="/assets/js/19.1374b4fc.js"><link rel="prefetch" href="/assets/js/20.aa0f50b5.js"><link rel="prefetch" href="/assets/js/21.7c796ab8.js"><link rel="prefetch" href="/assets/js/22.6bc36110.js"><link rel="prefetch" href="/assets/js/23.b1da491b.js"><link rel="prefetch" href="/assets/js/24.0eb99e5a.js"><link rel="prefetch" href="/assets/js/25.a9ece5c8.js"><link rel="prefetch" href="/assets/js/26.33f21d3d.js"><link rel="prefetch" href="/assets/js/27.f2a6eeb7.js"><link rel="prefetch" href="/assets/js/28.943b40ae.js"><link rel="prefetch" href="/assets/js/29.b3e0eb9c.js"><link rel="prefetch" href="/assets/js/30.7d572261.js"><link rel="prefetch" href="/assets/js/31.a602379b.js"><link rel="prefetch" href="/assets/js/32.82303652.js"><link rel="prefetch" href="/assets/js/33.0392f6ea.js"><link rel="prefetch" href="/assets/js/34.e68c4458.js"><link rel="prefetch" href="/assets/js/35.73b92b77.js"><link rel="prefetch" href="/assets/js/36.94cccae4.js"><link rel="prefetch" href="/assets/js/37.87daaeae.js"><link rel="prefetch" href="/assets/js/38.47a33431.js"><link rel="prefetch" href="/assets/js/39.017a6062.js"><link rel="prefetch" href="/assets/js/4.00ff60b8.js"><link rel="prefetch" href="/assets/js/40.d6e9da85.js"><link rel="prefetch" href="/assets/js/41.d7d6e000.js"><link rel="prefetch" href="/assets/js/42.534278aa.js"><link rel="prefetch" href="/assets/js/43.672c5a43.js"><link rel="prefetch" href="/assets/js/44.1be5b8c4.js"><link rel="prefetch" href="/assets/js/45.83835c91.js"><link rel="prefetch" href="/assets/js/46.1a03f3b0.js"><link rel="prefetch" href="/assets/js/47.507f1de7.js"><link rel="prefetch" href="/assets/js/48.dbb26232.js"><link rel="prefetch" href="/assets/js/49.c3c4d010.js"><link rel="prefetch" href="/assets/js/5.06848b4d.js"><link rel="prefetch" href="/assets/js/6.87f02c74.js"><link rel="prefetch" href="/assets/js/7.fadbe260.js"><link rel="prefetch" href="/assets/js/8.19f157a9.js"><link rel="prefetch" href="/assets/js/9.0c014273.js"><link rel="prefetch" href="/assets/js/vendors~docs-searchbar.9a2822a3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b26ff90a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Welcome to the Meilisearch dev specifications!</span></a> <div class="links"><form id="search-form" role="search" class="meilisearch-search-wrapper search-box"><input id="meilisearch-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/specifications/text/specifications/text/0000-specification-template.html" class="nav-link">
  Specification
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/specifications/text/specifications/text/0000-specification-template.html" class="nav-link">
  Specification
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/specifications/text/0000-specification-template.html" class="sidebar-link">Specification template</a></li><li><a href="/specifications/text/0001-frontend-disable-prod.html" class="sidebar-link">Frontend disable prod</a></li><li><a href="/specifications/text/0001-script-based-tokenizer.html" class="sidebar-link">Script based tokenizer</a></li><li><a href="/specifications/text/0027-filter-and-facet-behavior.html" aria-current="page" class="active sidebar-link">Filter and facet behavior</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/specifications/text/0027-filter-and-facet-behavior.html#_1-functional-specification" class="sidebar-link">1. Functional Specification</a></li><li class="sidebar-sub-header"><a href="/specifications/text/0027-filter-and-facet-behavior.html#_2-technical-aspects" class="sidebar-link">2. Technical Aspects</a></li><li class="sidebar-sub-header"><a href="/specifications/text/0027-filter-and-facet-behavior.html#_3-future-possibilities" class="sidebar-link">3. Future Possibilities</a></li></ul></li><li><a href="/specifications/text/0028-indexing-csv.html" class="sidebar-link">Indexing csv</a></li><li><a href="/specifications/text/0029-indexing-ndjson.html" class="sidebar-link">Indexing ndjson</a></li><li><a href="/specifications/text/0030-asc-desc-criterion.html" class="sidebar-link">Asc desc criterion</a></li><li><a href="/specifications/text/0032-distinct-attribute.html" class="sidebar-link">Distinct attribute</a></li><li><a href="/specifications/text/0033-logging.html" class="sidebar-link">Logging</a></li><li><a href="/specifications/text/0034-telemetry-policies.html" class="sidebar-link">Telemetry policies</a></li><li><a href="/specifications/text/0036-exactness-criterion.html" class="sidebar-link">Exactness criterion</a></li><li><a href="/specifications/text/0038-rename-attributes-for-faceting.html" class="sidebar-link">Rename attributes for faceting</a></li><li><a href="/specifications/text/0039-_formatted-field-behavior.html" class="sidebar-link">_formatted field behavior</a></li><li><a href="/specifications/text/0043-phrase-query.html" class="sidebar-link">Phrase query</a></li><li><a href="/specifications/text/0047-reset-stop-words-synonyms-settings-with-null.html" class="sidebar-link">Reset stop words synonyms settings with null</a></li><li><a href="/specifications/text/0048-rename-max-mdb-size-var.html" class="sidebar-link">Rename max mdb size var</a></li><li><a href="/specifications/text/0055-sort.html" class="sidebar-link">Sort</a></li><li><a href="/specifications/text/0059-geo-search.html" class="sidebar-link">Geo search</a></li><li><a href="/specifications/text/0060-tasks-api.html" class="sidebar-link">Tasks api</a></li><li><a href="/specifications/text/0061-error-format-and-definitions.html" class="sidebar-link">Error format and definitions</a></li><li><a href="/specifications/text/0077-words-position-limit.html" class="sidebar-link">Words position limit</a></li><li><a href="/specifications/text/0085-api-keys.html" class="sidebar-link">Api keys</a></li><li><a href="/specifications/text/0089-tenant-tokens.html" class="sidebar-link">Tenant tokens</a></li><li><a href="/specifications/text/0096-auto-batching.html" class="sidebar-link">Auto batching</a></li><li><a href="/specifications/text/0105-dumps-api.html" class="sidebar-link">Dumps api</a></li><li><a href="/specifications/text/0118-search-api.html" class="sidebar-link">Search api</a></li><li><a href="/specifications/text/0119-instance-options.html" class="sidebar-link">Instance options</a></li><li><a href="/specifications/text/0123-displayed-attributes-setting-api.html" class="sidebar-link">Displayed attributes setting api</a></li><li><a href="/specifications/text/0123-distinct-attribute-setting-api.html" class="sidebar-link">Distinct attribute setting api</a></li><li><a href="/specifications/text/0123-filterable-attributes-setting-api.html" class="sidebar-link">Filterable attributes setting api</a></li><li><a href="/specifications/text/0123-ranking-rules-setting-api.html" class="sidebar-link">Ranking rules setting api</a></li><li><a href="/specifications/text/0123-searchable-attributes-setting-api.html" class="sidebar-link">Searchable attributes setting api</a></li><li><a href="/specifications/text/0123-settings-api.html" class="sidebar-link">Settings api</a></li><li><a href="/specifications/text/0123-sortable-attributes-setting-api.html" class="sidebar-link">Sortable attributes setting api</a></li><li><a href="/specifications/text/0123-stop-words-setting-api.html" class="sidebar-link">Stop words setting api</a></li><li><a href="/specifications/text/0123-synonyms-setting-api.html" class="sidebar-link">Synonyms setting api</a></li><li><a href="/specifications/text/0124-documents-api.html" class="sidebar-link">Documents api</a></li><li><a href="/specifications/text/0132-indexes-api.html" class="sidebar-link">Indexes api</a></li><li><a href="/specifications/text/0134-stats-api.html" class="sidebar-link">Stats api</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><ul><li>Title: Filter and Facet Behavior</li> <li>Specification PR: <a href="https://github.com/meilisearch/specifications/pull/27" target="_blank" rel="noopener noreferrer">#27<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>MeiliSearch Tracking-Issues: <a href="https://github.com/meilisearch/milli/issues/152" target="_blank" rel="noopener noreferrer">milli/#152<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://github.com/meilisearch/transplant/issues/140" target="_blank" rel="noopener noreferrer">transplant/#140<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://github.com/meilisearch/transplant/issues/70" target="_blank" rel="noopener noreferrer">transplant/#70<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://github.com/meilisearch/transplant/issues/81" target="_blank" rel="noopener noreferrer">transplant/#81<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h1 id="facet-and-filter-behavior"><a href="#facet-and-filter-behavior" class="header-anchor">#</a> Facet and Filter Behavior</h1> <h2 id="_1-functional-specification"><a href="#_1-functional-specification" class="header-anchor">#</a> 1. Functional Specification</h2> <h3 id="i-summary"><a href="#i-summary" class="header-anchor">#</a> I. Summary</h3> <p>With v0.21.0, we are trying to erase the distinction between facets and filtering. <code>facetFilters</code> is removed as a query parameter. Instead, all filters are performed with the <code>filter</code> parameter. In addition, any attribute you wish to use with <code>filter</code> must first be added to attributesForFaceting.</p> <h3 id="ii-motivation"><a href="#ii-motivation" class="header-anchor">#</a> II. Motivation</h3> <p>Because the users need to set the attributes to <code>attributesForFaceting</code> no matter what they are using (<code>filters</code> or <code>facetFilters</code>) during the search, we need to re-define the usage of the filters/facets and stay as backwards compatible as possible with the MeiliSearch v0.20.0.</p> <h3 id="iii-additional-materials"><a href="#iii-additional-materials" class="header-anchor">#</a> III. Additional Materials</h3> <p>N/A</p> <h3 id="iv-explanation"><a href="#iv-explanation" class="header-anchor">#</a> IV. Explanation</h3> <h4 id="remove-facetfilters-rename-filters-to-filter"><a href="#remove-facetfilters-rename-filters-to-filter" class="header-anchor">#</a> Remove <code>facetFilters</code>, Rename <code>filters</code> to <code>filter</code></h4> <p>The usage of <code>facetFilters</code> is not needed anymore since everything is doable by only using the <code>filters</code> parameter.
We rename <code>filters</code> to <code>filter</code> mainly because the parameter's value will only ever be a single filter string, array or mixed syntax. Even if the value can be nested allowing for complexity, it's still just a logical expression. This name implicitly describes the action of filtering the results using a single filter expression made up of several logical operators.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// Settings</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;attributesForFaceting&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;author&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token comment">// Search</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;q&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;filters&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price &lt; 20&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;facetFilters&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;author:'JK Rowling'&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>becomes</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// Settings</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;attributesForFaceting&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;author&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;price&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token comment">// Search</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;q&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price &lt; 20 AND author = 'JK Rowling'&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We decided to replace the <code>:</code> operator in favor of <code>=</code>.</p> <h4 id="operator-behavior-during-search"><a href="#operator-behavior-during-search" class="header-anchor">#</a> Operator behavior during search</h4> <p>During search, logical operators should behave as they already do in MeiliSearch v0.20.0.</p> <p>Here is a quick reminder of the v0.20.0 operators behavior:</p> <ul><li><code>&lt;</code>, <code>=&lt;</code>, <code>&gt;</code>, <code>=&gt;</code> =&gt; only operate on number values. MeiliSearch returns only documents that have numbers in this field.
ex: <code>price &gt; 19</code> does not return <code>&quot;price&quot;: &quot;20&quot;</code> but returns <code>&quot;price&quot;: 20</code> -&gt; no type conversions are done.</li> <li><code>=</code>, <code>!=</code>/<code>NOT</code> =&gt; operate on string and number values. MeiliSearch returns only documents that have numbers, strings, or arrays of strings in this field.</li></ul> <h4 id="known-limitations"><a href="#known-limitations" class="header-anchor">#</a> Known limitations</h4> <ul><li>cannot filter on <code>null</code>, objects, arrays of &quot;undefined elements&quot; (ex: array of <code>null</code>)</li></ul> <h4 id="accepted-syntaxes-for-filter"><a href="#accepted-syntaxes-for-filter" class="header-anchor">#</a> Accepted syntaxes for <code>filter</code></h4> <p>Three syntaxes will be accepted for the <code>filter</code> parameter during search. <code>String syntax</code>, <code>Array syntax</code> and <code>Mixed syntax</code>.</p> <h5 id="string-syntax"><a href="#string-syntax" class="header-anchor">#</a> String syntax</h5> <p>The string syntax uses the <code>AND</code>/<code>OR</code>/<code>NOT</code> operators combined with parentheses to express a search filter.</p> <p>Example:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(genres = Comedy OR genres = Romance) AND director = 'Mati Diop'&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="array-syntax"><a href="#array-syntax" class="header-anchor">#</a> Array syntax</h5> <p>The array syntax uses dimensional array to express logical connectives.</p> <ul><li>Inner arrays elements are connected by an OR operator (e.g. [[&quot;genres:Comedy&quot;, &quot;genres:Romance&quot;]]).</li> <li>Outer arrays elements are connected by an AND operator (e.g. [&quot;genres:Romance&quot;, &quot;director:Mati Diop&quot;]).</li></ul> <p>Example:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;genres = Comedy&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;genres = Romance&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;director = 'Mati Diop'&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="mixed-syntax"><a href="#mixed-syntax" class="header-anchor">#</a> Mixed syntax</h5> <p>The mixed syntax can mix string and array syntaxes.</p> <p>Let's say that we want to translate</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token string">&quot;((genres = Comedy AND genres = Romance) OR genres = Action) AND director != 'Mati Diop'&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Example:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;genres = Comedy AND genres = Romance&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;genres = Action&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;NOT director = comedy&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>Note that string values that are longer than a single word need to be enclosed by quote. <code>&quot;director = Mati Diop&quot;</code> will lead to a parsing error. The valid syntax is <code>&quot;director = 'Mati Diop'&quot;</code>.</p></blockquote> <h4 id="filters-and-facetsdistribution-behavior"><a href="#filters-and-facetsdistribution-behavior" class="header-anchor">#</a> <code>filters</code> and <code>facetsDistribution</code> behavior</h4> <h5 id="meilisearch-v0-20-0-with-filters"><a href="#meilisearch-v0-20-0-with-filters" class="header-anchor">#</a> MeiliSearch v0.20.0 with <code>filters</code></h5> <p>In MeiliSeach v0.20.0, with the following documents</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">456</span><span class="token punctuation">,</span>  <span class="token property">&quot;genre&quot;</span><span class="token operator">:</span> <span class="token string">&quot;adventure&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">12</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token property">&quot;genre&quot;</span><span class="token operator">:</span> <span class="token string">&quot;fantasy&quot;</span><span class="token punctuation">,</span>   <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">456</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>...and the following search</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;q&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;filters&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price = 12&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;facetsDistribution&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;genre&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>...we get the following results:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;hits&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">456</span><span class="token punctuation">,</span>  <span class="token property">&quot;genre&quot;</span><span class="token operator">:</span> <span class="token string">&quot;adventure&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">12</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;facetsDistribution&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;genre&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;fantasy&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">&quot;adventure&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>=&gt; <code>fantasy</code> is set to <code>1</code> despite the fantasy book does not have a <code>price</code> equals to <code>12</code> as required in the <code>filters</code>.
=&gt; the <code>filters</code> and the <code>facetsDistribution</code> are not related: the <code>facetsDistribution</code> is applied before the filters.</p> <h5 id="meilisearch-v0-20-0-with-facetfilters"><a href="#meilisearch-v0-20-0-with-facetfilters" class="header-anchor">#</a> MeiliSearch v0.20.0 with <code>facetFilters</code></h5> <p>In MeiliSeach v0.20.0, with the following documents</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">456</span><span class="token punctuation">,</span>  <span class="token property">&quot;genre&quot;</span><span class="token operator">:</span> <span class="token string">&quot;adventure&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token string">&quot;12&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token property">&quot;genre&quot;</span><span class="token operator">:</span> <span class="token string">&quot;fantasy&quot;</span><span class="token punctuation">,</span>   <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token string">&quot;456&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>(the test is done with <code>price</code> as strings because MeiliSearch v0.20.0 cannot facet on numbers)</p> <p>...and the following search</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;q&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;facetFilters&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;price:12&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;facetsDistribution&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;genre&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>...we get the following results:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;hits&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">456</span><span class="token punctuation">,</span>  <span class="token property">&quot;genre&quot;</span><span class="token operator">:</span> <span class="token string">&quot;adventure&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token string">&quot;12&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;facetsDistribution&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;genre&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;fantasy&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token property">&quot;adventure&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>=&gt; <code>fantasy</code> is set to <code>0</code> because the fantasy book does not have a <code>price</code> equals to <code>12</code> as required in the <code>facetFilters</code>.
=&gt; the <code>filters</code> and the <code>facetsDistribution</code> are related: the <code>facetsDistribution</code> is applied after the facet filters.</p> <h5 id="final-decision-for-v0-21-0"><a href="#final-decision-for-v0-21-0" class="header-anchor">#</a> Final decision for v0.21.0</h5> <p>In MeiliSearch v0.21.0, <code>facetsDistribution</code> will behave with <code>filter</code> the same way it currently does with <code>facetFilters</code>: the <code>facetsDistribution</code> will be applied after the filters.</p> <h4 id="tldr-all-the-breaking-changes"><a href="#tldr-all-the-breaking-changes" class="header-anchor">#</a> TLDR; all the breaking changes</h4> <p>Here is the summary of all the breaking changes (that are detailed in the paragraphs above):</p> <ul><li>The <code>facetFilters</code> parameter during the search is removed. Only <code>filter</code> can be used.</li> <li>The <code>filters</code> parameter is renamed <code>filter</code>.</li> <li>The users need to set the attributes to <code>attributesForFaceting</code> to use the filters during the search via the <code>filter</code> parameters.</li> <li>The users can now pass an attribute containing numbers (float or integer) in <code>attributesForFaceting</code>. It means they can use <code>filter</code> and <code>facetsDistribution</code> on this numeric field.</li> <li>The <code>filter</code> parameter can accept three syntaxes: string (with <code>OR</code>/<code>AND</code>/<code>NOT</code>), array and a mixed with string and array.</li> <li>The <code>:</code> operator does not exist anymore (was previously present in <code>facetFilters</code> in v0.20.0) and is replaced by <code>=</code>.</li> <li>The <code>facetsDistribution</code> is now applied after the <code>filter</code> parameter. This point is currently not documented, not sure this is useful to add it to the docs.</li> <li>All the integer in the user documents are converted into float. So integers with high values lose precision. However, integers from −2^53 to 2^53 (−9007199254740992 to 9007199254740992) can be exactly represented, which is enough in 99% of cases. Not sure this is important to documented it either.</li></ul> <h3 id="v-impact-on-documentation"><a href="#v-impact-on-documentation" class="header-anchor">#</a> V. Impact on Documentation</h3> <p>See the previous part.</p> <p>The documentation should present a complex filter query with multiple levels to precise that MeiliSearch is not limited to deepness level.</p> <p>Example:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token string">&quot;((genres = Comedy OR genres = Romance) AND (director = 'Mati Diop' OR director = 'Wong Kar-wai')) OR genres = 'Fantasy'&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="vi-impact-on-sdks"><a href="#vi-impact-on-sdks" class="header-anchor">#</a> VI. Impact on SDKs</h3> <ul><li>Remove <code>facetFilters</code> from their payload.</li> <li>Rename <code>filters</code> to <code>filter</code>.</li></ul> <h2 id="_2-technical-aspects"><a href="#_2-technical-aspects" class="header-anchor">#</a> 2. Technical Aspects</h2> <h3 id="i-abstract"><a href="#i-abstract" class="header-anchor">#</a> I. Abstract</h3> <p>Internal MeiliSearch engine uses an index data structure for each type encountered in an attribute. Doing this eliminate the need for the user to strictly type the attribute and permits to deal with loosely typed document at indexing time. Thus, facilitating the developper experience.</p> <p>As for example, let’s imagine that we want to index two documents with a price attribute. One containing <code>&quot;price&quot;: &quot;20&quot;</code> and the second <code>&quot;price&quot;: 20</code> as value. The two attribute values will be stored in two different indexes.</p> <p>Using <code>=</code> or <code>!=</code> operator on <code>price</code> attribute will lead the engine to query the two indexes and get matching document ids with an <code>UNION</code> operation. So it will return documents matching <code>&quot;20&quot;</code> or <code>20</code> as values for the <code>price</code> attribute.</p> <h4 id="implementation-details"><a href="#implementation-details" class="header-anchor">#</a> Implementation Details</h4> <p>We have a database for the facets, the keys are prefixed by the field_id (u8), a level (u8) and, the facet value (f64). The facet values don't have a level when the type is a string. The data stored under those keys is the document ids that are faceted under those facets values.</p> <p>The type of the facet (i.e. f64 or string) is stored in another data structure and this is by using it that we know how to read the facet value. If the facet type is a number we are able to use more operators like greater than or lower than (e.g. &lt;, &lt;=, &gt;, &gt;=, =, !=).</p> <h5 id="indexing-phase"><a href="#indexing-phase" class="header-anchor">#</a> Indexing phase</h5> <p>When documents come in and fields are declared as facets, we start storing the facet values in the previously described database, the key becomes the facet value (as a globally ordered byte slice) and, the entry data now contains the document id that contains this facet value. Note that if the facet value is a number we store it like <code>[field id][level][left facet value][right facet value]</code> where the level is 0 and if it is a string then we don't store the level.</p> <p>Once the facet values that are numbers are stored we got a list of facet values prefixed with the field id and the base level (i.e. 0). We use this base level to generate more levels, each level contains groups of 4 groups of the level below, so level 1 aggregates the ids of the documents of each group of 4 facet values of level 0. The left and right facet values are the inclusive bounds of the group, the level 0 group have equal left and right bounds.</p> <h5 id="querying-phase"><a href="#querying-phase" class="header-anchor">#</a> Querying phase</h5> <p>Those levels are used to reduce the number of entries to run through, reducing the time it takes to answer too wide range filter queries, like duration &gt; 0 where 80% of the entries will match. We go through each of the levels going from the higher one, the one which describes the biggest amount of facet values and, we go deeper in the levels to find better fitting bounds.</p> <h2 id="_3-future-possibilities"><a href="#_3-future-possibilities" class="header-anchor">#</a> 3. Future Possibilities</h2> <ul><li>Provide facet statistics like <code>min</code> <code>max</code> <code>sum</code> <code>average</code></li> <li>Rename <code>attributesForFaceting</code> for clarity.</li> <li>Rename <code>facetsDistribution</code> for clarity.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/specifications/text/0001-script-based-tokenizer.html" class="prev">
        Script based tokenizer
      </a></span> <span class="next"><a href="/specifications/text/0028-indexing-csv.html">
        Indexing csv
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.37877e6b.js" defer></script><script src="/assets/js/3.7860be15.js" defer></script><script src="/assets/js/14.da29c9f9.js" defer></script>
  </body>
</html>
